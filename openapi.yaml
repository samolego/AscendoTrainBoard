openapi: 3.0.3
info:
  title: AscendoTrainBoard API
  description: |
    Ascendo TrainBoard allows clients to fetch custom climbing problems, alongside corresponding
    sector images and hold locations on the specified image.

    **Authentication:** Cookie-based sessions

    **Grading System:** Numeric grades (integers) - client converts to Fontainebleau scale
  version: 1.0.0
  contact:
    name: AscendoTrainBoard
servers:
  - url: http://localhost:3000/api/v1
    description: Local development server
  - url: http://{host}/api/v1
    description: Custom server
    variables:
      host:
        default: localhost:3000
        description: Server host and port

tags:
  - name: Authentication
    description: User authentication and session management
  - name: Sectors
    description: Climbing sectors (static, read-only, dynamically discovered from filesystem)
  - name: Problems
    description: Climbing problems CRUD operations
  - name: Grades
    description: User ratings and grade suggestions
  - name: Admin
    description: Administrative operations (admin only)

paths:
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user account
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          description: Invalid username or password
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Username already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Authenticate user and obtain session cookie
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user and clear session cookie
      operationId: logoutUser
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Logout successful
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /sectors:
    get:
      tags:
        - Sectors
      summary: Retrieve a list of all climbing sectors
      operationId: listSectors
      responses:
        "200":
          description: List of sectors
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SectorSummary"

  /sectors/{name}:
    get:
      tags:
        - Sectors
      summary: Retrieve details of a specific climbing sector by name
      operationId: getSector
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Sector name (folder name)
      responses:
        "200":
          description: Sector details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Sector"
        "404":
          description: Sector not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /sectors/{name}/image:
    get:
      tags:
        - Sectors
      summary: Retrieve the sector wall image
      operationId: getSectorImage
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Sector name (folder name)
      responses:
        "200":
          description: Sector image
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
        "404":
          description: Sector not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /problems:
    get:
      tags:
        - Problems
      summary: Retrieve a list of climbing problems with optional filtering and pagination
      operationId: listProblems
      parameters:
        - name: sector
          in: query
          required: false
          schema:
            type: string
          description: Filter by sector name
        - name: min_grade
          in: query
          required: false
          schema:
            type: integer
          description: Filter by minimum grade
        - name: max_grade
          in: query
          required: false
          schema:
            type: integer
          description: Filter by maximum grade
        - name: name
          in: query
          required: false
          schema:
            type: string
          description: Filter by problem name
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number
        - name: per_page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Items per page
      responses:
        "200":
          description: Paginated list of problems
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemList"
    post:
      tags:
        - Problems
      summary: Create a new climbing problem
      operationId: createProblem
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateProblemRequest"
      responses:
        "201":
          description: Problem created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Problem"
        "400":
          description: Invalid data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Sector not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /problems/{id}:
    get:
      tags:
        - Problems
      summary: Retrieve details of a specific climbing problem by ID
      operationId: getProblem
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Problem ID
      responses:
        "200":
          description: Problem details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Problem"
        "404":
          description: Problem not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      tags:
        - Problems
      summary: Update an existing climbing problem
      operationId: updateProblem
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Problem ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProblemRequest"
      responses:
        "200":
          description: Problem updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Problem"
        "400":
          description: Invalid data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not the problem owner or admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Problem not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - Problems
      summary: Delete a climbing problem
      operationId: deleteProblem
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Problem ID
      responses:
        "204":
          description: Problem deleted successfully
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not the problem owner or admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Problem not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /problems/{id}/grades:
    get:
      tags:
        - Grades
      summary: Retrieve all grades/ratings for a specific problem
      operationId: getProblemGrades
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Problem ID
      responses:
        "200":
          description: Problem grades and ratings
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemGrades"
        "404":
          description: Problem not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags:
        - Grades
      summary: Submit or update a grade/rating for a problem
      operationId: submitProblemGrade
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Problem ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubmitGradeRequest"
      responses:
        "200":
          description: Grade updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Grade"
        "201":
          description: Grade created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Grade"
        "400":
          description: Invalid grade or stars value
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Problem not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /admin/users:
    get:
      tags:
        - Admin
      summary: Retrieve a list of all users
      operationId: listUsers
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserDetail"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not an admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /admin/users/{id}:
    get:
      tags:
        - Admin
      summary: Retrieve details of a specific user by ID
      operationId: getUser
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: User ID
      responses:
        "200":
          description: User details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserDetail"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not an admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      tags:
        - Admin
      summary: Update user details
      operationId: updateUser
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: User ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateUserRequest"
      responses:
        "200":
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserDetail"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not an admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Username already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - Admin
      summary: Delete a user account
      operationId: deleteUser
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: User ID
      responses:
        "204":
          description: User deleted successfully
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not an admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Bearer token obtained from login/register

  schemas:
    Error:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Error message description
          example: Invalid credentials
        code:
          type: string
          description: Error code
          example: INVALID_CREDENTIALS

    RegisterRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
          example: john_doe
        password:
          type: string
          minLength: 6
          format: password
          example: secure_password123

    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: john_doe
        password:
          type: string
          format: password
          example: secure_password123

    LoginResponse:
      type: object
      required:
        - token
        - username
      properties:
        token:
          type: string
          example: 1a2b3c4d5e6f7g8h9i0j
          description: Authentication token to be used in Authorization header
        username:
          type: string
          example: john_doe

    User:
      type: object
      required:
        - id
        - username
        - is_admin
      properties:
        id:
          type: integer
          format: int32
          example: 1
        username:
          type: string
          example: john_doe
        is_admin:
          type: boolean
          example: false

    UserDetail:
      type: object
      required:
        - id
        - username
        - is_admin
        - created_at
      properties:
        id:
          type: integer
          format: int32
          example: 1
        username:
          type: string
          example: john_doe
        is_admin:
          type: boolean
          example: false
        created_at:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"

    UpdateUserRequest:
      type: object
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
          example: new_username
        password:
          type: string
          minLength: 6
          format: password
          example: new_password123
        is_admin:
          type: boolean
          example: true

    SectorSummary:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          example: sector-a
          description: Sector name (matches folder name)

    Sector:
      type: object
      required:
        - name
        - holds
      properties:
        name:
          type: string
          example: sector-a
          description: Sector name (matches folder name)
        holds:
          type: array
          description: Array of hold bounding boxes [start_x, start_y, end_x, end_y] in pixels
          items:
            type: array
            items:
              type: integer
              format: int32
            minItems: 4
            maxItems: 4
          example:
            [[100, 150, 120, 170], [200, 175, 215, 190], [150, 300, 165, 320]]

    ProblemSummary:
      type: object
      required:
        - id
        - author
        - grade
        - sector_name
      properties:
        id:
          type: integer
          format: int32
          example: 1
        name:
          type: string
          example: The Crimp Master
          description: Problem name (defaults to "Problem {id}" if not provided)
        description:
          type: string
          nullable: true
          example: A technical problem focusing on crimps
        author:
          type: string
          example: john_doe
        grade:
          type: integer
          format: int32
          example: 6
          description: Numeric grade (converted to Fontainebleau on client)
        sector_name:
          type: string
          example: sector-a
          description: Sector name
        average_grade:
          type: number
          format: float
          nullable: true
          example: 6.5
          description: Average of all user-submitted grades (null if no grades)
        average_stars:
          type: number
          format: float
          nullable: true
          example: 4.5
          description: Average of all user ratings (null if no grades)
        updated_at:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"

    Problem:
      allOf:
        - $ref: "#/components/schemas/ProblemSummary"
        - type: object
          required:
            - hold_sequence
          properties:
            hold_sequence:
              type: array
              description: "Array of [index, type] where index is the hold index of the sector's holds array (0-indexed) and type is hold type (0=Start, 1=Foot, 2=Normal, 3=End)"
              items:
                type: array
                items:
                  type: integer
                  format: int32
                minItems: 2
                maxItems: 2
              example: [[0, 0], [1, 2], [124, 3]]

    ProblemList:
      type: object
      required:
        - problems
        - total
        - page
        - per_page
      properties:
        problems:
          type: array
          items:
            $ref: "#/components/schemas/ProblemSummary"
        total:
          type: integer
          format: int32
          example: 42
          description: Total number of problems matching the filter
        page:
          type: integer
          format: int32
          example: 1
          description: Current page number
        per_page:
          type: integer
          format: int32
          example: 20
          description: Number of items per page

    CreateProblemRequest:
      type: object
      required:
        - grade
        - sector_name
        - hold_sequence
      properties:
        name:
          type: string
          example: The Crimp Master
          description: Problem name (defaults to "Problem {id}" if not provided)
        description:
          type: string
          example: A technical problem focusing on crimps
        grade:
          type: integer
          format: int32
          example: 6
          description: Numeric grade (converted to Fontainebleau on client)
        sector_name:
          type: string
          example: sector-a
          description: Sector name (must match an existing sector folder)
        hold_sequence:
          type: array
          description: "Array of [index, type] where row/col are indices into the sector's holds array (0-indexed) and type is hold type (0=Start, 1=Foot, 2=Normal, 3=End)"
          items:
            type: array
            items:
              type: integer
              format: int32
            minItems: 3
            maxItems: 3
          minItems: 1
          example: [[0, 1, 0], [1, 2, 2], [2, 3, 3]]

    UpdateProblemRequest:
      type: object
      properties:
        name:
          type: string
          example: Updated Name
        description:
          type: string
          example: Updated description
        grade:
          type: integer
          format: int32
          example: 7
        hold_sequence:
          type: array
          description: "Array of [index, type] where index is the hold index of the sector's holds array (0-indexed) and type is hold type (0=Start, 1=Foot, 2=Normal, 3=End)"
          items:
            type: array
            items:
              type: integer
              format: int32
            minItems: 2
            maxItems: 2
          minItems: 1
          example: [[0, 0], [1, 2], [124, 3]]

    Grade:
      type: object
      required:
        - username
        - grade
        - stars
        - created_at
      properties:
        username:
          type: string
          example: john_doe
        grade:
          type: integer
          format: int32
          example: 6
          description: User's suggested grade (integer, converted to Fontainebleau on client)
        stars:
          type: integer
          format: int32
          minimum: 1
          maximum: 5
          example: 4
          description: User's rating (1-5 stars)
        created_at:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"

    ProblemGrades:
      type: object
      required:
        - problem_id
        - grades
        - average_grade
        - average_stars
      properties:
        problem_id:
          type: integer
          format: int32
          example: 1
        grades:
          type: array
          items:
            $ref: "#/components/schemas/Grade"
        average_grade:
          type: number
          format: float
          nullable: true
          example: 6.5
          description: Calculated average of all submitted grades
        average_stars:
          type: number
          format: float
          nullable: true
          example: 4.5
          description: Calculated average of all star ratings

    SubmitGradeRequest:
      type: object
      required:
        - grade
        - stars
      properties:
        grade:
          type: integer
          format: int32
          example: 6
          description: Suggested grade (integer, converted to Fontainebleau on client)
        stars:
          type: integer
          format: int32
          minimum: 1
          maximum: 5
          example: 4
          description: Rating (1-5 stars)
