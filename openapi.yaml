openapi: 3.0.3
info:
  title: AscendoTrainBoard API
  description: |
    Ascendo TrainBoard allows clients to fetch custom climbing problems, alongside corresponding
    sector images and hold locations on the specified image.

    **Authentication:** Cookie-based sessions

    **Grading System:** Numeric grades (integers) - client converts to Fontainebleau scale

    **Rate Limiting:** Login attempts are rate limited by IP address to prevent brute force attacks.
    After each failed login attempt, the wait time increases by 3 seconds (3s, 6s, 9s, 12s).
    After 5 failed attempts, the IP is banned for 2 hours.
  version: 1.0.0
  contact:
    name: AscendoTrainBoard
servers:
  - url: http://localhost:3000/api/v1
    description: Local development server
  - url: http://{host}/api/v1
    description: Custom server
    variables:
      host:
        default: localhost:3000
        description: Server host and port

tags:
  - name: Authentication
    description: User authentication and session management
  - name: Sectors
    description: Climbing sectors (static, read-only, dynamically discovered from filesystem)
  - name: Problems
    description: Climbing problems CRUD operations
  - name: Grades
    description: User ratings and grade suggestions
  - name: Admin
    description: Administrative operations (admin only)

paths:
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register a new user account
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterRequest"
      responses:
        "201":
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          description: Invalid username or password
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Username already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Authenticate user and obtain session cookie
      description: |
        Authenticates a user with username and password. This endpoint is protected by rate limiting:
        - Failed attempts require progressive wait times (3s * number of failed attempts)
        - After 5 failed attempts from the same IP, the IP is banned for 2 hours
        - Successful login clears the failure count for that IP
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                invalidCredentials:
                  value:
                    error: "Invalid credentials"
                    code: "INVALID_CREDENTIALS"
                    timeout: 3
                  summary: Invalid credentials - must wait 3 seconds (increases with each failed attempt)
        "429":
          description: Too many login attempts - rate limited or banned
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
              examples:
                rateLimited:
                  value:
                    error: "Please wait before trying again"
                    code: "RATE_LIMIT"
                    timeout: 3
                  summary: Rate limited - must wait before next attempt
                banned:
                  value:
                    error: "Too many failed login attempts. Account temporarily banned."
                    code: "BANNED"
                    timeout: 7200
                  summary: IP banned for 2 hours (7200 seconds) after 5 failed attempts

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user and clear session cookie
      operationId: logoutUser
      security:
        - bearerAuth: []
      responses:
        "204":
          description: Logout successful
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /auth/rotate_token:
    get:
      tags:
        - Authentication
      summary: Recreates token and gets current authenticated user information
      description: |
        Invalidates old token on the server and generates new one.
        Returns the current authenticated user's information based on the session cookie.
        Use this endpoint to check if the session is still valid and restore user state on app startup.
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Current user information
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "401":
          description: Not authenticated or session expired
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /sectors:
    get:
      tags:
        - Sectors
      summary: Retrieve a list of all climbing sectors
      operationId: listSectors
      responses:
        "200":
          description: List of sectors
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SectorSummary"

  /sectors/{id}:
    get:
      tags:
        - Sectors
      summary: Retrieve details of a specific climbing sector by ID
      operationId: getSector
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int32
          description: Sector ID
      responses:
        "200":
          description: Sector details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Sector"
        "404":
          description: Sector not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /sectors/{id}/image:
    get:
      tags:
        - Sectors
      summary: Retrieve the sector wall image
      operationId: getSectorImage
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int32
          description: Sector ID
      responses:
        "200":
          description: Sector image
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
        "404":
          description: Sector not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /problems:
    get:
      tags:
        - Problems
      summary: Retrieve a list of climbing problems with optional filtering and pagination
      operationId: listProblems
      parameters:
        - name: sector_id
          in: query
          required: false
          schema:
            type: integer
            format: int32
          description: Filter by sector ID
        - name: min_grade
          in: query
          required: false
          schema:
            type: integer
          description: Filter by minimum grade
        - name: max_grade
          in: query
          required: false
          schema:
            type: integer
          description: Filter by maximum grade
        - name: name
          in: query
          required: false
          schema:
            type: string
          description: Filter by problem name
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number
        - name: per_page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Items per page
      responses:
        "200":
          description: Paginated list of problems
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProblemList"
    post:
      tags:
        - Problems
      summary: Create a new climbing problem
      operationId: createProblem
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateProblemRequest"
      responses:
        "201":
          description: Problem created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Problem"
        "400":
          description: Invalid data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Sector not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /problems/{id}:
    get:
      tags:
        - Problems
      summary: Retrieve details of a specific climbing problem by ID
      operationId: getProblem
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Problem ID
      responses:
        "200":
          description: Problem details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Problem"
        "404":
          description: Problem not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      tags:
        - Problems
      summary: Update an existing climbing problem
      operationId: updateProblem
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Problem ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateProblemRequest"
      responses:
        "200":
          description: Problem updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Problem"
        "400":
          description: Invalid data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not the problem owner or admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Problem not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - Problems
      summary: Delete a climbing problem
      operationId: deleteProblem
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Problem ID
      responses:
        "204":
          description: Problem deleted successfully
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not the problem owner or admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Problem not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      tags:
        - Grades
      summary: Submit or update a grade/rating for a problem
      operationId: submitProblemGrade
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: Problem ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubmitGradeRequest"
      responses:
        "200":
          description: Grade updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Grade"
        "201":
          description: Grade created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Grade"
        "400":
          description: Invalid grade or stars value
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Problem not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /admin/users:
    get:
      tags:
        - Admin
      summary: Retrieve a list of all users
      operationId: listUsers
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserDetail"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not an admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /admin/users/{id}:
    get:
      tags:
        - Admin
      summary: Retrieve details of a specific user by ID
      operationId: getUser
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: User ID
      responses:
        "200":
          description: User details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserDetail"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not an admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      tags:
        - Admin
      summary: Update user details
      operationId: updateUser
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: User ID
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateUserRequest"
      responses:
        "200":
          description: User updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserDetail"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not an admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "409":
          description: Username already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - Admin
      summary: Delete a user account
      operationId: deleteUser
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
          description: User ID
      responses:
        "204":
          description: User deleted successfully
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "403":
          description: Not an admin
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Bearer token obtained from login/register

  schemas:
    Error:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Error message description
          example: Invalid credentials
        code:
          type: string
          description: |
            Error code. Common values include:
            - INVALID_CREDENTIALS: Invalid username or password
            - RATE_LIMIT: Too many login attempts, must wait before retry
            - BANNED: IP banned due to excessive failed login attempts
            - NOT_AUTHENTICATED: Authentication required
            - FORBIDDEN: Insufficient permissions
            - NOT_FOUND: Resource not found
            - INVALID_USERNAME, INVALID_PASSWORD, etc.: Validation errors
          example: INVALID_CREDENTIALS
        timeout:
          type: integer
          format: int64
          nullable: true
          description: |
            Number of seconds to wait before retrying. Present for authentication-related errors:
            - For INVALID_CREDENTIALS: wait time before next attempt (3s Ã— failed attempt count, or 7200s if banned)
            - For RATE_LIMIT: seconds until next login attempt is allowed
            - For BANNED: seconds until ban expires (7200 for 2 hours)
            - null for other error types
          example: 3

    RegisterRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
          example: john_doe
        password:
          type: string
          minLength: 6
          format: password
          example: secure_password123

    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: john_doe
        password:
          type: string
          format: password
          example: secure_password123

    LoginResponse:
      type: object
      required:
        - token
        - username
        - is_admin
      properties:
        token:
          type: string
          example: 1a2b3c4d5e6f7g8h9i0j
          description: Authentication token to be used in Authorization header
        username:
          type: string
          example: john_doe
        is_admin:
          type: boolean
          example: false

    UserDetail:
      type: object
      required:
        - id
        - username
        - is_admin
        - created_at
      properties:
        id:
          type: integer
          format: int32
          example: 1
        username:
          type: string
          example: john_doe
        is_admin:
          type: boolean
          example: false
        created_at:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"

    UpdateUserRequest:
      type: object
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
          example: new_username
        password:
          type: string
          minLength: 6
          format: password
          example: new_password123
        is_admin:
          type: boolean
          example: true

    SectorSummary:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: integer
          format: int32
          example: 1
          description: Unique sector ID
        name:
          type: string
          example: sector-a
          description: Sector display name (if not set, the folder name is used)

    Sector:
      type: object
      required:
        - id
        - name
        - holds
        - image_width
        - image_height
      properties:
        id:
          type: integer
          format: int32
          example: 1
          description: Unique sector ID
        name:
          type: string
          example: sector-a
          description: Sector name (matches folder name)
        holds:
          type: array
          description: Array of hold bounding boxes [start_x, start_y, end_x, end_y] in pixels
          items:
            type: array
            items:
              type: integer
              format: int32
            minItems: 4
            maxItems: 4
          example:
            [[100, 150, 120, 170], [200, 175, 215, 190], [150, 300, 165, 320]]
        image_width:
          type: integer
          format: int32
          example: 3200
          description: Width of the sector image in pixels
        image_height:
          type: integer
          format: int32
          example: 2400
          description: Height of the sector image in pixels

    ProblemSummary:
      type: object
      required:
        - id
        - name
        - author
        - grade
        - sector_id
      properties:
        id:
          type: integer
          format: int32
          example: 1
        name:
          type: string
          example: The Crimp Master
          description: Problem name (defaults to "Problem {id}" if not provided)
        description:
          type: string
          nullable: true
          example: A technical problem focusing on crimps
        author:
          type: string
          example: john_doe
        grade:
          type: integer
          format: int32
          example: 5
          description: Numeric grade (converted to Fontainebleau on client)
        sector_id:
          type: integer
          format: int32
          example: 1
          description: Sector ID
        average_grade:
          type: number
          format: float
          nullable: true
          example: 6.5
          description: Average of all user-submitted grades (null if no grades)
        average_stars:
          type: number
          format: float
          nullable: true
          example: 4.5
          description: Average of all user ratings (null if no grades)
        updated_at:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"

    Problem:
      allOf:
        - $ref: "#/components/schemas/ProblemSummary"
        - type: object
          required:
            - hold_sequence
            - grades
          properties:
            hold_sequence:
              type: array
              description: "Array of [index, type] where index is the hold index of the sector's holds array (0-indexed) and type is hold type (0=Start, 1=Foot, 2=Normal, 3=End)"
              items:
                type: array
                items:
                  type: integer
                  format: int32
                minItems: 2
                maxItems: 2
              example: [[0, 0], [1, 2], [124, 3]]
            grades:
              type: array
              description: Array of user-submitted grades and ratings for this problem
              items:
                $ref: "#/components/schemas/Grade"

    ProblemList:
      type: object
      required:
        - problems
        - total
        - page
        - per_page
      properties:
        problems:
          type: array
          items:
            $ref: "#/components/schemas/ProblemSummary"
        total:
          type: integer
          format: int32
          example: 42
          description: Total number of problems matching the filter
        page:
          type: integer
          format: int32
          example: 1
          description: Current page number
        per_page:
          type: integer
          format: int32
          example: 20
          description: Number of items per page

    CreateProblemRequest:
      type: object
      required:
        - grade
        - sector_id
        - hold_sequence
      properties:
        name:
          type: string
          example: The Crimp Master
          description: Problem name (defaults to "Problem {id}" if not provided)
        description:
          type: string
          example: A technical problem focusing on crimps
        grade:
          type: integer
          format: int32
          example: 5
          description: Numeric grade (converted to Fontainebleau on client)
        sector_id:
          type: integer
          format: int32
          example: 1
          description: Sector ID (must match an existing sector)
        hold_sequence:
          type: array
          description: "Array of [index, type] where row/col are indices into the sector's holds array (0-indexed) and type is hold type (0=Start, 1=Foot, 2=Normal, 3=End)"
          items:
            type: array
            items:
              type: integer
              format: int32
            minItems: 3
            maxItems: 3
          minItems: 1
          example: [[0, 1, 0], [1, 2, 2], [2, 3, 3]]

    UpdateProblemRequest:
      type: object
      properties:
        name:
          type: string
          example: Updated Name
        description:
          type: string
          example: Updated description
        grade:
          type: integer
          format: int32
          example: 7
        hold_sequence:
          type: array
          description: "Array of [index, type] where index is the hold index of the sector's holds array (0-indexed) and type is hold type (0=Start, 1=Foot, 2=Normal, 3=End)"
          items:
            type: array
            items:
              type: integer
              format: int32
            minItems: 2
            maxItems: 2
          minItems: 1
          example: [[0, 0], [1, 2], [124, 3]]

    Grade:
      type: object
      required:
        - username
        - grade
        - stars
        - created_at
      properties:
        username:
          type: string
          example: john_doe
        grade:
          type: integer
          format: int32
          example: 6
          description: User's suggested grade (integer, converted to Fontainebleau on client)
        stars:
          type: integer
          format: int32
          minimum: 1
          maximum: 5
          example: 4
          description: User's rating (1-5 stars)
        created_at:
          type: string
          format: date-time
          example: "2025-01-15T10:30:00Z"

    SubmitGradeRequest:
      type: object
      required:
        - grade
        - stars
      properties:
        grade:
          type: integer
          format: int32
          example: 6
          description: Suggested grade (integer, converted to Fontainebleau on client)
        stars:
          type: integer
          format: int32
          minimum: 1
          maximum: 5
          example: 4
          description: Rating (1-5 stars)
